<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{.Title}} - Floaty</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>{{.Title}}</h1>
        <p class="subtitle"><a href="/">← back</a></p>
        
        <div class="total-display">
            <div class="total-label">Current Total</div>
            <div class="total-value" id="total">0.00</div>
        </div>

        <div class="controls">
            <input type="text" class="note-input" id="note" placeholder="Note (optional)">
            <input type="number" id="value" placeholder="Amount" step="0.01" value="10">
            <div class="button-group">
                <button class="btn-add" onclick="addValue()">add</button>
                <button class="btn-subtract" onclick="subtractValue()">subtract</button>
            </div>
        </div>

        <div class="events-section">
            <div class="events-title">
                <span>History</span>
                <button class="refresh-btn" onclick="loadData()">refresh</button>
            </div>
            <div class="events-list" id="events">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        const slug = '{{.Slug}}';
        
        async function loadData() {
            try {
                const [totalRes, eventsRes] = await Promise.all([
                    fetch('/api/' + slug + '/total'),
                    fetch('/api/' + slug + '/events')
                ]);
                
                const totalData = await totalRes.json();
                const events = await eventsRes.json();
                
                document.getElementById('total').textContent = totalData.total.toFixed(2);
                
                const eventsContainer = document.getElementById('events');
                if (events.length === 0) {
                    eventsContainer.innerHTML = '<div class="loading">No events yet. Add your first transaction!</div>';
                    return;
                }
                
                events.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                eventsContainer.innerHTML = events.map(event => {
                    const date = new Date(event.timestamp);
                    const isPositive = event.value >= 0;
                    const eventClass = event.type === 'recurring' ? 'event-recurring' : 'event-manual';
                    const sign = isPositive ? '+' : '';
                    const valueClass = isPositive ? 'positive' : 'negative';
                    const noteText = event.note || (event.type === 'recurring' ? 'Monthly recurring' : '—');
                    const deleteBtn = event.type === 'manual' ? '<button class="btn-delete" onclick="deleteEvent(\'' + event.id + '\')">delete</button>' : '';
                    
                    return '<div class="event-item ' + eventClass + '">' +
                        '<div class="event-details">' +
                        '<div class="event-time">' + date.toLocaleString() + '</div>' +
                        '<div class="event-note">' + noteText + '</div>' +
                        '</div>' +
                        '<div class="event-value ' + valueClass + '">' +
                        sign + event.value.toFixed(2) +
                        '</div>' +
                        deleteBtn +
                        '</div>';
                }).join('');
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('events').innerHTML = '<div class="loading">Error loading events</div>';
            }
        }

        async function addValue() {
            const value = parseFloat(document.getElementById('value').value);
            const note = document.getElementById('note').value;
            
            if (isNaN(value) || value <= 0) {
                alert('Please enter a valid positive number');
                return;
            }
            
            try {
                await fetch('/api/' + slug + '/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value, note })
                });
                
                document.getElementById('note').value = '';
                loadData();
            } catch (error) {
                console.error('Error adding value:', error);
                alert('Failed to add value');
            }
        }

        async function subtractValue() {
            const value = parseFloat(document.getElementById('value').value);
            const note = document.getElementById('note').value;
            
            if (isNaN(value) || value <= 0) {
                alert('Please enter a valid positive number');
                return;
            }
            
            try {
                await fetch('/api/' + slug + '/subtract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value, note })
                });
                
                document.getElementById('note').value = '';
                loadData();
            } catch (error) {
                console.error('Error subtracting value:', error);
                alert('Failed to subtract value');
            }
        }

        async function deleteEvent(id) {
            if (!confirm('Are you sure you want to delete this transaction?')) {
                return;
            }

            try {
                await fetch('/api/' + slug + '/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                
                loadData();
            } catch (error) {
                console.error('Error deleting event:', error);
                alert('Failed to delete event');
            }
        }

        document.getElementById('value').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addValue();
        });

        document.getElementById('note').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addValue();
        });

        loadData();
        setInterval(loadData, 30000);
    </script>
</body>
</html>
