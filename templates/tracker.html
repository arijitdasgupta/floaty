<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{.Title}} - Floaty</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>{{.Title}}</h1>
        <p class="subtitle"><a href="/">← back</a></p>
        
        <div class="total-display">
            <div class="total-label">Current Total</div>
            <div class="total-value" id="total">0.00</div>
        </div>

        <div class="controls">
            <input type="text" class="note-input" id="note" placeholder="Note (optional)">
            <input type="number" id="value" placeholder="Amount" step="0.01" value="10">
            <div class="button-group">
                <button class="btn-add" onclick="addValue()">add</button>
                <button class="btn-subtract" onclick="subtractValue()">subtract</button>
            </div>
        </div>

        <div class="events-section">
            <div class="events-title">
                <span>History</span>
                <button class="refresh-btn" onclick="loadData()">refresh</button>
            </div>
            <div class="events-list" id="events">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        const slug = '{{.Slug}}';
        
        async function loadData() {
            try {
                const [totalRes, eventsRes] = await Promise.all([
                    fetch('/api/' + slug + '/total'),
                    fetch('/api/' + slug + '/events')
                ]);
                
                const totalData = await totalRes.json();
                const events = await eventsRes.json();
                
                document.getElementById('total').textContent = totalData.total.toFixed(2);
                
                const eventsContainer = document.getElementById('events');
                if (events.length === 0) {
                    eventsContainer.innerHTML = '<div class="loading">No events yet. Add your first transaction!</div>';
                    return;
                }
                
                events.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                eventsContainer.innerHTML = events.map(event => {
                    const date = new Date(event.timestamp);
                    const isPositive = event.value >= 0;
                    const eventClass = event.type === 'recurring' ? 'event-recurring' : 'event-manual';
                    const sign = isPositive ? '+' : '';
                    const valueClass = isPositive ? 'positive' : 'negative';
                    const noteText = event.note || (event.type === 'recurring' ? 'Monthly recurring' : '—');
                    const deleteBtn = event.type === 'manual' ? '<button class="btn-delete" onclick="deleteEvent(\'' + event.id + '\')">delete</button>' : '';
                    const editBtn = event.type === 'manual' ? '<button class="btn-delete" onclick="toggleEdit(\'' + event.id + '\')">edit</button>' : '';
                    
                    return '<div class="event-item ' + eventClass + '" id="event-' + event.id + '" data-id="' + event.id + '" data-value="' + event.value + '" data-note="' + (event.note || '') + '">' +
                        '<div class="event-details">' +
                        '<div class="event-time">' + date.toLocaleString() + '</div>' +
                        '<div class="event-note" id="note-' + event.id + '">' + noteText + '</div>' +
                        '<div class="event-note" id="note-input-' + event.id + '" style="display:none;">' +
                        '<input type="text" id="note-edit-input-' + event.id + '" value="' + (event.note || '').replace(/"/g, '&quot;') + '" style="width:100%; border:none; border-bottom:1px solid #ccc; padding:4px 0; font-family:Georgia; font-size:1em; background:transparent;" onkeypress="if(event.key===\'Enter\')saveEdit(\'' + event.id + '\')">' +
                        '</div>' +
                        '</div>' +
                        '<div class="event-value ' + valueClass + '" id="value-' + event.id + '">' +
                        sign + event.value.toFixed(2) +
                        '</div>' +
                        '<div class="event-value" id="value-input-' + event.id + '" style="display:none;">' +
                        '<input type="number" id="value-edit-input-' + event.id + '" value="' + Math.abs(event.value) + '" step="0.01" style="width:80px; border:none; border-bottom:1px solid #ccc; padding:4px 0; font-family:Georgia; font-size:1.1em; background:transparent; text-align:right;" onkeypress="if(event.key===\'Enter\')saveEdit(\'' + event.id + '\')">' +
                        '</div>' +
                        '<button class="btn-delete" id="save-' + event.id + '" style="display:none;" onclick="saveEdit(\'' + event.id + '\')">save</button>' +
                        '<button class="btn-delete" id="cancel-' + event.id + '" style="display:none;" onclick="cancelEdit(\'' + event.id + '\')">cancel</button>' +
                        editBtn +
                        deleteBtn +
                        '</div>';
                }).join('');
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('events').innerHTML = '<div class="loading">Error loading events</div>';
            }
        }

        function toggleEdit(id) {
            // Hide normal view
            document.getElementById('note-' + id).style.display = 'none';
            document.getElementById('value-' + id).style.display = 'none';
            
            // Show input view
            document.getElementById('note-input-' + id).style.display = 'block';
            document.getElementById('value-input-' + id).style.display = 'block';
            
            // Show save/cancel buttons, hide edit/delete buttons
            document.getElementById('save-' + id).style.display = 'inline';
            document.getElementById('cancel-' + id).style.display = 'inline';
            
            // Find and hide edit/delete buttons
            const eventItem = document.getElementById('event-' + id);
            const buttons = eventItem.querySelectorAll('.btn-delete');
            buttons.forEach(btn => {
                if (btn.id !== 'save-' + id && btn.id !== 'cancel-' + id) {
                    btn.style.display = 'none';
                }
            });
        }

        function cancelEdit(id) {
            // Show normal view
            document.getElementById('note-' + id).style.display = 'block';
            document.getElementById('value-' + id).style.display = 'block';
            
            // Hide input view
            document.getElementById('note-input-' + id).style.display = 'none';
            document.getElementById('value-input-' + id).style.display = 'none';
            
            // Hide save/cancel buttons, show edit/delete buttons
            document.getElementById('save-' + id).style.display = 'none';
            document.getElementById('cancel-' + id).style.display = 'none';
            
            const eventItem = document.getElementById('event-' + id);
            const buttons = eventItem.querySelectorAll('.btn-delete');
            buttons.forEach(btn => {
                if (btn.id !== 'save-' + id && btn.id !== 'cancel-' + id) {
                    btn.style.display = 'inline';
                }
            });
            
            // Reset input values
            const originalValue = parseFloat(eventItem.dataset.value);
            const originalNote = eventItem.dataset.note;
            document.getElementById('value-edit-input-' + id).value = Math.abs(originalValue);
            document.getElementById('note-edit-input-' + id).value = originalNote;
        }

        async function saveEdit(id) {
            const eventItem = document.getElementById('event-' + id);
            const originalValue = parseFloat(eventItem.dataset.value);
            const isNegative = originalValue < 0;
            
            let newValue = parseFloat(document.getElementById('value-edit-input-' + id).value);
            const newNote = document.getElementById('note-edit-input-' + id).value;
            
            if (isNaN(newValue) || newValue <= 0) {
                alert('Please enter a valid positive number');
                return;
            }
            
            // Apply sign based on original value
            if (isNegative) {
                newValue = -newValue;
            }
            
            try {
                await fetch('/api/' + slug + '/edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, value: newValue, note: newNote })
                });
                
                loadData();
            } catch (error) {
                console.error('Error editing event:', error);
                alert('Failed to edit event');
            }
        }

        async function addValue() {
            const value = parseFloat(document.getElementById('value').value);
            const note = document.getElementById('note').value;
            
            if (isNaN(value) || value <= 0) {
                alert('Please enter a valid positive number');
                return;
            }
            
            try {
                await fetch('/api/' + slug + '/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value, note })
                });
                
                document.getElementById('note').value = '';
                loadData();
            } catch (error) {
                console.error('Error adding value:', error);
                alert('Failed to add value');
            }
        }

        async function subtractValue() {
            const value = parseFloat(document.getElementById('value').value);
            const note = document.getElementById('note').value;
            
            if (isNaN(value) || value <= 0) {
                alert('Please enter a valid positive number');
                return;
            }
            
            try {
                await fetch('/api/' + slug + '/subtract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value, note })
                });
                
                document.getElementById('note').value = '';
                loadData();
            } catch (error) {
                console.error('Error subtracting value:', error);
                alert('Failed to subtract value');
            }
        }

        async function deleteEvent(id) {
            if (!confirm('Are you sure you want to delete this transaction?')) {
                return;
            }

            try {
                await fetch('/api/' + slug + '/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                
                loadData();
            } catch (error) {
                console.error('Error deleting event:', error);
                alert('Failed to delete event');
            }
        }

        document.getElementById('value').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addValue();
        });

        document.getElementById('note').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addValue();
        });

        loadData();
        setInterval(loadData, 30000);
    </script>
</body>
</html>
